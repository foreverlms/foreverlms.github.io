<!DOCTYPE html>
<html>

<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	
	<title>C Primer Plus--位操作</title>
	<meta name="description" content="C中位字段(bit field)">
	<meta name="keywords" content="c, C Primer Plus, 寒鸥惊起一双双" />
	<link rel="canonical" href="https://blog.bobliao.xyz/%E7%AC%94%E8%AE%B0/2018/03/17/c-bit-operation.html">
	<link rel="alternate" type="application/rss+xml" title="寒鸥惊起一双双" href="https://blog.bobliao.xyz/feed.xml" />
   	<link rel="stylesheet" type="text/css" href="/css/index.css">
</head>

<body>
<div class="body-wrapper">
<div class="nav-header">
<a href="/">寒鸥惊起一双双</a> | <a href="https://github.com/foreverlms" target="_blank">Github</a> |<a href="/about"> 关于我 </a></div>
<div class="main-body">
<header>
<h2>C Primer Plus--位操作</h2>
<p><i>2018-03-17</i></p>
</header>
<article>
<p>C中位字段(bit field)
<!--more--></p>

<h2 id="位字段-bit-field">位字段 bit field</h2>
<blockquote>
  <p>位字段是一个<code class="highlighter-rouge">signed int</code>或者<code class="highlighter-rouge">unsigned int</code>中一组相邻的位。位字段由一个结构声明建立，该结构声明为每个字段提供标签，并决定字段的宽度。</p>
</blockquote>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">struct</span> <span class="n">p</span> <span class="p">{</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">autfd</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span><span class="c1">//autfd字段占一个int其中的1位宽度</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bldfc</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">undln</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">itals</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
    <span class="c1">//字节剩下的位空出</span>
<span class="p">}</span> <span class="p">;</span>
<span class="k">struct</span> <span class="n">p</span> <span class="n">pt</span><span class="p">;</span>
<span class="n">pt</span><span class="p">.</span><span class="n">autfd</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="n">pt</span><span class="p">.</span><span class="n">bldfc</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="c1">//...</span>
</code></pre></div></div>
<p>这里生命了一个<code class="highlighter-rouge">p</code>，其包含四个一位字段。<code class="highlighter-rouge">p</code>被存储在一个usigned int大小的存储单元中，但仅使用了其中的4位。
字段的位数可以是多位。</p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="k">struct</span> <span class="n">pp</span> <span class="p">{</span>
        <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">code1</span> <span class="o">:</span> <span class="mi">2</span><span class="p">;</span>
        <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">code2</span> <span class="o">:</span> <span class="mi">2</span><span class="p">;</span>
        <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">code3</span> <span class="o">:</span> <span class="mi">4</span><span class="p">;</span>
        <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">code4</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span> <span class="p">;</span><span class="c1">//pp中声明了两个2位字段，一个4位字段，一个1位字段</span>
</code></pre></div></div>
<p><code class="highlighter-rouge">pp</code>会占两个<code class="highlighter-rouge">unsigned int</code>存储单元，但是只会按顺序使用其中的9位。
如果声明的位字段总位数超过一个<code class="highlighter-rouge">unsigned int</code>空间，像上面那样，相邻的下一个<code class="highlighter-rouge">unsigned int</code>存储空间会被利用。但是不允许一个位字段的位数跨越两个<code class="highlighter-rouge">unsigned int</code>的边界。当出现一个位字段位数跨越了边界时，编译器会自动移除掉这个位字段，空出来，就像一个洞一样，使得边界对齐。
可以使用未命名的字段填充这样的洞。当指定<strong>未命名位字段</strong>宽度为0时，会使得下一个位字段变量移动到下一个<code class="highlighter-rouge">unsigned int</code>边界开始计算位数。</p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">struct</span> <span class="n">ppp</span> <span class="p">{</span>
        <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">field1</span> <span class="o">:</span> <span class="mi">2</span><span class="p">;</span>
        <span class="kt">unsigned</span> <span class="kt">int</span>        <span class="o">:</span> <span class="mi">2</span><span class="p">;</span><span class="c1">//空出两位</span>
        <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">field2</span> <span class="o">:</span> <span class="mi">3</span><span class="p">;</span><span class="c1">//然后才算field2占3位</span>
        <span class="kt">unsigned</span> <span class="kt">int</span>        <span class="o">:</span> <span class="mi">0</span><span class="p">;</span><span class="c1">//field3必须从下一个unsigned int开始算位数</span>
        <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">field3</span> <span class="o">:</span> <span class="mi">2</span><span class="p">;</span>
    <span class="p">};</span>
</code></pre></div></div>
<p>位字段由于在不同机器上可能会有不同的存储顺序，对于字段边界位置也有区别，因此难以移植。
这样的结构赋值可以像普通struct那样进行赋值：</p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">struct</span> <span class="p">{</span>
        <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">field1</span> <span class="o">:</span> <span class="mi">2</span><span class="p">;</span>
        <span class="kt">unsigned</span> <span class="kt">int</span>        <span class="o">:</span> <span class="mi">2</span><span class="p">;</span><span class="c1">//空出两位</span>
        <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">field2</span> <span class="o">:</span> <span class="mi">3</span><span class="p">;</span><span class="c1">//然后才算field2占3位</span>
        <span class="kt">unsigned</span> <span class="kt">int</span>        <span class="o">:</span> <span class="mi">0</span><span class="p">;</span><span class="c1">//field3必须从下一个unsigned int开始算位数</span>
        <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">field3</span> <span class="o">:</span> <span class="mi">2</span><span class="p">;</span>
    <span class="p">}</span> <span class="n">ppp</span> <span class="o">=</span> <span class="p">{</span>
            <span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span>
    <span class="p">};</span><span class="c1">//需要注意1,1,3按顺序值不能超出位字段位数限制</span>
</code></pre></div></div>
<p>这一章我没有仔细看。</p>

</article>
<div id="info-bottom">
<hr>
<p>标签: <block class="tag"><a href="/archive/#c">c</a></block><block class="tag"><a href="/archive/#C Primer Plus">C Primer Plus</a></block></p>
<p><b>留言</b>请用 <a href="https://github.com/foreverlms/foreverlms.github.io/issues"> Github Issues </a></p>
<p><b>聊天</b>请在 <a href="https://gitter.im/foreverlms/community" target="_blank">gitter.im/foreverlms</a> </p>
</div>

</div>
<div class="info-bottom"><div class="info-bottom-text">
License <a href="http://creativecommons.org/licenses/by-nc-sa/3.0/">(CC) BY-NC-SA</a> | Subscribe <a href="/feed.xml">RSS</a> | Email <a href="mailto:codechaser@163.com">codechaser囧163.com</a> | 博客模板 <a href="https://fzheng.me/" target="_blank">无求备斋笔记</a>
</div></div> 
</div>
</body>
<script src="https://use.typekit.net/hvv6ahj.js"></script>
<script>try{Typekit.load({ async: true });}catch(e){}</script>
</html>